<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Building Ambient Music: A Set-and-Forget Music Experience for Android | Sourajit Karmakar</title>
<meta name="keywords" content="android, kotlin, exoplayer, media3, background-services, mobile-development">
<meta name="description" content="A deep dive into the architecture and implementation of Ambient Music&#39;s playback service, exploring the design decisions and challenges in building a seamless background music experience.">
<meta name="author" content="Sourajit Karmakar">
<link rel="canonical" href="https://sourajitk.github.io/posts/building-ambient-music-app/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css" integrity="sha256-2jIR5e&#43;Ge/K3X9WmUVz&#43;1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://sourajitk.github.io/favicon.svg">
<link rel="icon" type="image/png" sizes="16x16" href="https://sourajitk.github.io/favicon.svg">
<link rel="icon" type="image/png" sizes="32x32" href="https://sourajitk.github.io/favicon.svg">
<link rel="apple-touch-icon" href="https://sourajitk.github.io/favicon.svg">
<link rel="mask-icon" href="https://sourajitk.github.io/favicon.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://sourajitk.github.io/posts/building-ambient-music-app/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script>
<link rel="stylesheet" href="/css/custom.css">
<meta property="og:url" content="https://sourajitk.github.io/posts/building-ambient-music-app/">
  <meta property="og:site_name" content="Sourajit Karmakar">
  <meta property="og:title" content="Building Ambient Music: A Set-and-Forget Music Experience for Android">
  <meta property="og:description" content="A deep dive into the architecture and implementation of Ambient Music&#39;s playback service, exploring the design decisions and challenges in building a seamless background music experience.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-01-27T12:00:00+00:00">
    <meta property="article:modified_time" content="2025-01-27T12:00:00+00:00">
    <meta property="article:tag" content="Android">
    <meta property="article:tag" content="Kotlin">
    <meta property="article:tag" content="Exoplayer">
    <meta property="article:tag" content="Media3">
    <meta property="article:tag" content="Background-Services">
    <meta property="article:tag" content="Mobile-Development">
      <meta property="og:image" content="https://sourajitk.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://sourajitk.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name="twitter:title" content="Building Ambient Music: A Set-and-Forget Music Experience for Android">
<meta name="twitter:description" content="A deep dive into the architecture and implementation of Ambient Music&#39;s playback service, exploring the design decisions and challenges in building a seamless background music experience.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://sourajitk.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Building Ambient Music: A Set-and-Forget Music Experience for Android",
      "item": "https://sourajitk.github.io/posts/building-ambient-music-app/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Building Ambient Music: A Set-and-Forget Music Experience for Android",
  "name": "Building Ambient Music: A Set-and-Forget Music Experience for Android",
  "description": "A deep dive into the architecture and implementation of Ambient Music's playback service, exploring the design decisions and challenges in building a seamless background music experience.",
  "keywords": [
    "android", "kotlin", "exoplayer", "media3", "background-services", "mobile-development"
  ],
  "articleBody": " When I set out to build Ambient Music, I wanted to create something that “just works” — a music player you could start and forget about. No playlists to manage, no complex UI to navigate. Just hit play and let it handle the rest.\nWhat I didn’t expect was how much complexity would be hidden behind that simple user experience. The core of the app — the playback service that keeps music running seamlessly in the background — took significant time to perfect. In this post, I’ll walk through the architecture, design decisions, and implementation details that make it all work.\nThe Architecture At its heart, Ambient Music is built around a foreground service that manages continuous playback. The service needs to:\nHandle playback state across app lifecycle events Integrate with Android’s media system (MediaSession, notifications, Quick Settings) Manage genre-based playlists dynamically Handle audio focus and interruptions gracefully Keep the UI in sync with playback state The main component that orchestrates all of this is MusicPlaybackService, a foreground service that uses ExoPlayer for media playback and Media3’s MediaSession for system integration.\nSongsRepo: Dynamic Track Loading Before the playback service can play music, it needs tracks to play. This is where SongsRepo comes in — a singleton object that manages fetching, caching, and providing song data to the rest of the app.\nRemote-First with Local Fallback The app uses a remote-first approach: tracks are fetched from a remote JSON file hosted at https://www.ambient-music.online/songs.json. This allows updating the playlist without requiring app updates. However, the app also maintains a local cache for offline functionality.\nobject SongsRepo { private const val REMOTE_SONGS_URL = \"https://www.ambient-music.online/songs.json\" private const val LOCAL_CACHE_FILE_NAME = \"songs_cache.json\" @Volatile private var internalLoadedSongs: List = emptyList() var currentTrackIndex = 0 private set } The @Volatile annotation ensures thread-safe access, which is critical since the repository is accessed from multiple threads (UI thread, background coroutines, service thread).\nData Model Songs are represented as SongAsset data classes using Kotlin’s serialization:\n@Serializable data class SongAsset( val url: String, val title: String, val artist: String, val albumArtUrl: String? = null, val genre: String? = null, ) The JSON parser is configured to be lenient and ignore unknown keys, making it resilient to schema changes:\nprivate val jsonParser = Json { ignoreUnknownKeys = true isLenient = true } Initialization and Refresh The initializeAndRefresh method handles the complete refresh cycle:\nClear local cache - Ensures fresh data on each refresh Fetch from remote - Downloads the latest JSON Parse and update - Deserializes the JSON and updates the internal list Save to cache - Persists the data locally for offline use fun initializeAndRefresh(context: Context, onFinished: ((Boolean, String) -\u003e Unit)? = null) { CoroutineScope(Dispatchers.IO).launch { // Clear Local Cache clearCache(context) // Attempt to fetch the JSON from remote try { val request = Request.Builder().url(REMOTE_SONGS_URL).build() client.newCall(request).execute().use { response -\u003e if (response.isSuccessful) { val jsonString = response.body.string() val remoteSongs = jsonParser.decodeFromString",
  "wordCount" : "1270",
  "inLanguage": "en",
  "image": "https://sourajitk.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished": "2025-01-27T12:00:00Z",
  "dateModified": "2025-01-27T12:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Sourajit Karmakar"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://sourajitk.github.io/posts/building-ambient-music-app/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Sourajit Karmakar",
    "logo": {
      "@type": "ImageObject",
      "url": "https://sourajitk.github.io/favicon.svg"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://sourajitk.github.io/" accesskey="h" title="Sourajit Karmakar (Alt + H)"></a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://unsplash.com/@sourajitk" title="Unsplash Gallery">
                    <span>Unsplash Gallery</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://www.ambient-music.online/player/" title="Ambient Music Web">
                    <span>Ambient Music Web</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Building Ambient Music: A Set-and-Forget Music Experience for Android
    </h1>
    <div class="post-description">
      A deep dive into the architecture and implementation of Ambient Music&#39;s playback service, exploring the design decisions and challenges in building a seamless background music experience.
    </div>
    <div class="post-meta"><span title='2025-01-27 12:00:00 +0000 +0000'>January 27, 2025</span>&nbsp;·&nbsp;<span>Sourajit Karmakar</span>

</div>
  </header> 
  <div class="post-content"><!-- raw HTML omitted -->
<p>When I set out to build <a href="https://github.com/sourajitk/Ambient-Music">Ambient Music</a>, I wanted to create something that &ldquo;just works&rdquo; — a music player you could start and forget about. No playlists to manage, no complex UI to navigate. Just hit play and let it handle the rest.</p>
<p>What I didn&rsquo;t expect was how much complexity would be hidden behind that simple user experience. The core of the app — the playback service that keeps music running seamlessly in the background — took significant time to perfect. In this post, I&rsquo;ll walk through the architecture, design decisions, and implementation details that make it all work.</p>
<h2 id="the-architecture">The Architecture<a hidden class="anchor" aria-hidden="true" href="#the-architecture">#</a></h2>
<p>At its heart, Ambient Music is built around a foreground service that manages continuous playback. The service needs to:</p>
<ul>
<li>Handle playback state across app lifecycle events</li>
<li>Integrate with Android&rsquo;s media system (MediaSession, notifications, Quick Settings)</li>
<li>Manage genre-based playlists dynamically</li>
<li>Handle audio focus and interruptions gracefully</li>
<li>Keep the UI in sync with playback state</li>
</ul>
<p>The main component that orchestrates all of this is <code>MusicPlaybackService</code>, a foreground service that uses ExoPlayer for media playback and Media3&rsquo;s MediaSession for system integration.</p>
<h2 id="songsrepo-dynamic-track-loading">SongsRepo: Dynamic Track Loading<a hidden class="anchor" aria-hidden="true" href="#songsrepo-dynamic-track-loading">#</a></h2>
<p>Before the playback service can play music, it needs tracks to play. This is where <code>SongsRepo</code> comes in — a singleton object that manages fetching, caching, and providing song data to the rest of the app.</p>
<h3 id="remote-first-with-local-fallback">Remote-First with Local Fallback<a hidden class="anchor" aria-hidden="true" href="#remote-first-with-local-fallback">#</a></h3>
<p>The app uses a remote-first approach: tracks are fetched from a remote JSON file hosted at <code>https://www.ambient-music.online/songs.json</code>. This allows updating the playlist without requiring app updates. However, the app also maintains a local cache for offline functionality.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#66d9ef">object</span> <span style="color:#a6e22e">SongsRepo</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">val</span> REMOTE_SONGS_URL = <span style="color:#e6db74">&#34;https://www.ambient-music.online/songs.json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">val</span> LOCAL_CACHE_FILE_NAME = <span style="color:#e6db74">&#34;songs_cache.json&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Volatile</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">var</span> internalLoadedSongs: List&lt;SongAsset&gt; = emptyList()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> currentTrackIndex = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">set</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>@Volatile</code> annotation ensures thread-safe access, which is critical since the repository is accessed from multiple threads (UI thread, background coroutines, service thread).</p>
<h3 id="data-model">Data Model<a hidden class="anchor" aria-hidden="true" href="#data-model">#</a></h3>
<p>Songs are represented as <code>SongAsset</code> data classes using Kotlin&rsquo;s serialization:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#a6e22e">@Serializable</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">data</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SongAsset</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> url: String,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> title: String,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> artist: String,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> albumArtUrl: String? = <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> genre: String? = <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>The JSON parser is configured to be lenient and ignore unknown keys, making it resilient to schema changes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">val</span> jsonParser = Json {
</span></span><span style="display:flex;"><span>    ignoreUnknownKeys = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    isLenient = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="initialization-and-refresh">Initialization and Refresh<a hidden class="anchor" aria-hidden="true" href="#initialization-and-refresh">#</a></h3>
<p>The <code>initializeAndRefresh</code> method handles the complete refresh cycle:</p>
<ol>
<li><strong>Clear local cache</strong> - Ensures fresh data on each refresh</li>
<li><strong>Fetch from remote</strong> - Downloads the latest JSON</li>
<li><strong>Parse and update</strong> - Deserializes the JSON and updates the internal list</li>
<li><strong>Save to cache</strong> - Persists the data locally for offline use</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">initializeAndRefresh</span>(context: Context, onFinished: ((Boolean, String) <span style="color:#f92672">-&gt;</span> Unit)? = <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>    CoroutineScope(<span style="color:#a6e22e">Dispatchers</span>.IO).launch {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Clear Local Cache
</span></span></span><span style="display:flex;"><span>        clearCache(context)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Attempt to fetch the JSON from remote
</span></span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">val</span> request = <span style="color:#a6e22e">Request</span>.Builder().url(REMOTE_SONGS_URL).build()
</span></span><span style="display:flex;"><span>            client.newCall(request).execute().use { response <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (response.isSuccessful) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">val</span> jsonString = response.body.string()
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">val</span> remoteSongs = jsonParser.decodeFromString&lt;List&lt;SongAsset&gt;&gt;(jsonString)
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    synchronized(<span style="color:#66d9ef">this</span><span style="color:#a6e22e">@SongsRepo</span>) {
</span></span><span style="display:flex;"><span>                        internalLoadedSongs = remoteSongs
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> (currentTrackIndex <span style="color:#f92672">&gt;=</span> internalLoadedSongs.size 
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&amp;&amp;</span> internalLoadedSongs.isNotEmpty()) {
</span></span><span style="display:flex;"><span>                            currentTrackIndex = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                        saveToCache(context, jsonString)
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    overallSuccess = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (e: IOException) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Handle network errors
</span></span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (e: SerializationException) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Handle parsing errors
</span></span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        withContext(<span style="color:#a6e22e">Dispatchers</span>.Main) { 
</span></span><span style="display:flex;"><span>            onFinished<span style="color:#f92672">?.</span>invoke(overallSuccess, finalStatusMessage) 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The method runs entirely on a background thread (<code>Dispatchers.IO</code>) and uses <code>synchronized</code> blocks to ensure thread-safe updates to the internal state. The callback is switched back to the main thread for UI updates.</p>
<h3 id="thread-safe-access">Thread-Safe Access<a hidden class="anchor" aria-hidden="true" href="#thread-safe-access">#</a></h3>
<p>All public accessors use <code>synchronized</code> blocks to ensure thread safety:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#66d9ef">val</span> songs: List&lt;SongAsset&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">get</span>() = synchronized(<span style="color:#66d9ef">this</span><span style="color:#a6e22e">@SongsRepo</span>) { internalLoadedSongs }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">getCurrentSong</span>(): SongAsset? = 
</span></span><span style="display:flex;"><span>    synchronized(<span style="color:#66d9ef">this</span><span style="color:#a6e22e">@SongsRepo</span>) { 
</span></span><span style="display:flex;"><span>        internalLoadedSongs.getOrNull(currentTrackIndex) 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">selectTrack</span>(index: Int) {
</span></span><span style="display:flex;"><span>    synchronized(<span style="color:#66d9ef">this</span><span style="color:#a6e22e">@SongsRepo</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (index <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> index &lt; internalLoadedSongs.size) {
</span></span><span style="display:flex;"><span>            currentTrackIndex = index
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This ensures that even when the repository is being updated from a background thread, reads from the UI thread or service thread remain consistent.</p>
<h2 id="the-playback-service-core-design">The Playback Service: Core Design<a hidden class="anchor" aria-hidden="true" href="#the-playback-service-core-design">#</a></h2>
<p>The <code>MusicPlaybackService</code> is where most of the complexity lives. Let me break down the key design decisions and how they work together.</p>
<h3 id="genre-based-playback">Genre-Based Playback<a hidden class="anchor" aria-hidden="true" href="#genre-based-playback">#</a></h3>
<p>One of the app&rsquo;s key features is genre-based playback. Users can select different genres (chill, calm, sleep, focus, serenity) and the service filters the playlist accordingly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">playGenre</span>(genre: String) {
</span></span><span style="display:flex;"><span>    currentPlaylistGenre = genre
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> genreSongs = <span style="color:#a6e22e">SongsRepo</span>.songs.filter { 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">it</span>.genre.equals(genre, ignoreCase = <span style="color:#66d9ef">true</span>) 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (genreSongs.isEmpty()) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Log</span>.w(TAG, <span style="color:#e6db74">&#34;No songs found for genre: </span><span style="color:#e6db74">$genre</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> mediaItems = genreSongs.map { songData <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">val</span> metadataBuilder = <span style="color:#a6e22e">MediaMetadata</span>.Builder()
</span></span><span style="display:flex;"><span>            .setTitle(songData.title)
</span></span><span style="display:flex;"><span>            .setArtist(songData.artist)
</span></span><span style="display:flex;"><span>        songData.albumArtUrl<span style="color:#f92672">?.</span>let { 
</span></span><span style="display:flex;"><span>            metadataBuilder.setArtworkUri(<span style="color:#66d9ef">it</span>.toUri()) 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">MediaItem</span>.Builder()
</span></span><span style="display:flex;"><span>            .setUri(songData.url)
</span></span><span style="display:flex;"><span>            .setMediaId(songData.url)
</span></span><span style="display:flex;"><span>            .setMediaMetadata(metadataBuilder.build())
</span></span><span style="display:flex;"><span>            .build()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    exoPlayer<span style="color:#f92672">?.</span>shuffleModeEnabled = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> startIndex = genreSongs.indices.random()
</span></span><span style="display:flex;"><span>    exoPlayer<span style="color:#f92672">?.</span>setMediaItems(mediaItems, startIndex, <span style="color:#a6e22e">C</span>.TIME_UNSET)
</span></span><span style="display:flex;"><span>    exoPlayer<span style="color:#f92672">?.</span>prepare()
</span></span><span style="display:flex;"><span>    exoPlayer<span style="color:#f92672">?.</span>play()
</span></span><span style="display:flex;"><span>    isPlaylistSet = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The genre filtering happens at runtime, which means the same JSON file can contain multiple genres and the app dynamically creates playlists based on user selection. Shuffle is enabled by default, and playback starts from a random index to provide variety.</p>
<h3 id="asynchronous-album-art-loading">Asynchronous Album Art Loading<a hidden class="anchor" aria-hidden="true" href="#asynchronous-album-art-loading">#</a></h3>
<p>Album art is loaded asynchronously using Coil (a modern image loading library for Android). This prevents blocking the main thread while fetching images:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">fetchArtworkAsync</span>(artworkUri: Uri) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> request = <span style="color:#a6e22e">ImageRequest</span>.Builder(<span style="color:#66d9ef">this</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#66d9ef">data</span>(artworkUri)
</span></span><span style="display:flex;"><span>        .target(
</span></span><span style="display:flex;"><span>            onSuccess = { result: Drawable <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>                currentAlbumArt = result.toBitmap()
</span></span><span style="display:flex;"><span>                updateNotification()
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            onError = {
</span></span><span style="display:flex;"><span>                currentAlbumArt = <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>                updateNotification()
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        .build()
</span></span><span style="display:flex;"><span>    imageLoader.enqueue(request)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The artwork is fetched whenever a new track starts playing, triggered by the <code>onMediaItemTransition</code> callback:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">onMediaItemTransition</span>(mediaItem: MediaItem?, reason: Int) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> newIndex = <span style="color:#66d9ef">this</span><span style="color:#a6e22e">@apply</span>.currentMediaItemIndex
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">SongsRepo</span>.selectTrack(newIndex)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Clear old art and fetch new art on transition
</span></span></span><span style="display:flex;"><span>    currentAlbumArt = <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>    mediaItem<span style="color:#f92672">?.</span>mediaMetadata<span style="color:#f92672">?.</span>artworkUri<span style="color:#f92672">?.</span>let { 
</span></span><span style="display:flex;"><span>        fetchArtworkAsync(<span style="color:#66d9ef">it</span>) 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    updateNotification()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="notification-management">Notification Management<a hidden class="anchor" aria-hidden="true" href="#notification-management">#</a></h3>
<p>The notification serves multiple purposes:</p>
<ol>
<li>Keeps the service running as a foreground service</li>
<li>Provides media controls to the user</li>
<li>Displays current track information</li>
<li>Integrates with MediaSession for system-wide controls</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#a6e22e">@OptIn</span>(UnstableApi<span style="color:#f92672">::</span><span style="color:#66d9ef">class</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">createNotification</span>(): Notification {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> currentExoPlayerMediaItem = exoPlayer<span style="color:#f92672">?.</span>currentMediaItem
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> currentMediaMetadata = currentExoPlayerMediaItem<span style="color:#f92672">?.</span>mediaMetadata
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> songFromRepo = <span style="color:#a6e22e">SongsRepo</span>.getCurrentSong()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> title = currentMediaMetadata<span style="color:#f92672">?.</span>title<span style="color:#f92672">?.</span>toString()<span style="color:#f92672">?.</span>takeIf { <span style="color:#66d9ef">it</span>.isNotBlank() }
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">?:</span> songFromRepo<span style="color:#f92672">?.</span>title
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">?:</span> getString(<span style="color:#a6e22e">R</span>.string.qs_tile_notification_title_unknown)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> builder = <span style="color:#a6e22e">NotificationCompat</span>.Builder(<span style="color:#66d9ef">this</span>, NOTIFICATION_CHANNEL_ID)
</span></span><span style="display:flex;"><span>        .setContentTitle(title)
</span></span><span style="display:flex;"><span>        .setContentText(artist)
</span></span><span style="display:flex;"><span>        .setSmallIcon(<span style="color:#a6e22e">R</span>.drawable.ic_music_note)
</span></span><span style="display:flex;"><span>        .setLargeIcon(currentAlbumArt)
</span></span><span style="display:flex;"><span>        .setOngoing(<span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>        .setVisibility(<span style="color:#a6e22e">NotificationCompat</span>.VISIBILITY_PUBLIC)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    mediaSession<span style="color:#f92672">?.</span>let { session <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">val</span> mediaStyle = <span style="color:#a6e22e">MediaStyleNotificationHelper</span>.MediaStyle(session)
</span></span><span style="display:flex;"><span>            .setShowActionsInCompactView(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        builder.setStyle(mediaStyle)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> builder.build()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The notification uses <code>MediaStyle</code>, which integrates with MediaSession to provide standard media controls. The <code>setOngoing(true)</code> ensures the notification can&rsquo;t be swiped away while music is playing.</p>
<h2 id="design-challenges-and-solutions">Design Challenges and Solutions<a hidden class="anchor" aria-hidden="true" href="#design-challenges-and-solutions">#</a></h2>
<h3 id="challenge-1-state-synchronization">Challenge 1: State Synchronization<a hidden class="anchor" aria-hidden="true" href="#challenge-1-state-synchronization">#</a></h3>
<p>Keeping the UI, Quick Settings tile, and service state in sync was tricky. The solution was using companion object properties with <code>@Volatile</code> and a utility class (<code>TileStateUtil</code>) that can request tile updates from anywhere.</p>
<h3 id="challenge-2-genre-switching">Challenge 2: Genre Switching<a hidden class="anchor" aria-hidden="true" href="#challenge-2-genre-switching">#</a></h3>
<p>When a user switches genres while music is playing, we need to avoid mixing tracks from different genres. The <code>currentPlaylistGenre</code> property tracks the active genre, and genre-specific actions always filter the playlist before setting it.</p>
<h3 id="challenge-3-notification-updates">Challenge 3: Notification Updates<a hidden class="anchor" aria-hidden="true" href="#challenge-3-notification-updates">#</a></h3>
<p>Notifications need to update smoothly when tracks change. The <code>updateNotification</code> method is called on every state change, but it only calls <code>startForeground</code> when not playing (to avoid unnecessary foreground service restarts) and uses <code>notify</code> when playing.</p>
<h3 id="challenge-4-error-recovery">Challenge 4: Error Recovery<a hidden class="anchor" aria-hidden="true" href="#challenge-4-error-recovery">#</a></h3>
<p>If ExoPlayer becomes null or encounters an error, the service attempts recovery:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (exoPlayer <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Log</span>.e(TAG, <span style="color:#e6db74">&#34;ExoPlayer is null in togglePlayback. Aborting.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Attempt recovery
</span></span></span><span style="display:flex;"><span>    initializePlayerAndSession()
</span></span><span style="display:flex;"><span>    prepareAndSetPlaylist()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="try-it-out">Try It Out<a hidden class="anchor" aria-hidden="true" href="#try-it-out">#</a></h2>
<p>The app is available on the <a href="https://play.google.com/store/apps/details?id=com.sourajitk.ambient_music">Google Play Store</a> and the source code is open source on <a href="https://github.com/sourajitk/Ambient-Music">GitHub</a>.</p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted -->
<!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p>The playback service represents months of iteration, testing, and refinement. What looks like a simple &ldquo;play music&rdquo; feature is actually a complex system managing state, resources, and system integration. But that&rsquo;s the beauty of good software — the complexity is hidden, and the user experience is simple.</p>
<p>If you&rsquo;re building something similar or have questions about the implementation, feel free to check out the <a href="https://github.com/sourajitk/Ambient-Music">source code</a> or open an issue on GitHub!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://sourajitk.github.io/tags/android/">Android</a></li>
      <li><a href="https://sourajitk.github.io/tags/kotlin/">Kotlin</a></li>
      <li><a href="https://sourajitk.github.io/tags/exoplayer/">Exoplayer</a></li>
      <li><a href="https://sourajitk.github.io/tags/media3/">Media3</a></li>
      <li><a href="https://sourajitk.github.io/tags/background-services/">Background-Services</a></li>
      <li><a href="https://sourajitk.github.io/tags/mobile-development/">Mobile-Development</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="https://sourajitk.github.io/">Sourajit Karmakar</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
